"""
LLM 기반 디자이너(Designer) KPI 직접 평가 모듈.

Few-shot Learning을 활용하여 이력서 텍스트에서 
디자이너 KPI 10개에 대한 점수를 직접 산출.
"""
from typing import Dict
from openai import OpenAI
import json

from app.core.config import settings


# KPI 정의 및 평가 기준
KPI_DEFINITIONS = """
## 디자이너 KPI 10개 및 평가 기준

아래 예시는 **"기준표"** 역할을 함 → 지원자 경험이 **이 중 어디와 가장 비슷한지만 판단**

---

## 공통 원칙 (중요)

- 모든 예시는 **이력서 문단 그대로 들어가도 자연스러운 서술**
- **도구 이름보다 판단/행동/결과 중심**
- 구조: **상황 → 행동 → 결과**
- 결과·근거 없는 감상 ❌
- "예쁘다" ❌ → **문제·구조·의도·확장성** ⭕
- 산출물 나열만 있으면 **상 불가**
- "학습/경험"만 있으면 **하**
- "운영 중 문제 → 구조/전략 변경"이 있으면 **상**

## 점수 범위
- **상**: 75~90점 (강한 상=88~90, 보통 상=80~87, 약한 상=75~79)
- **중**: 55~70점 (강한 중=67~70, 보통 중=60~66, 약한 중=55~59)
- **하**: 40~50점 (언급 있음=48~50, 약간 언급=44~47, 전혀 없음=40~43)

## 평가 원칙
- 명시적으로 언급되지 않은 KPI는 "하(40~45)" 처리
- 도구/기술 이름만 나열하면 "중(55~65)" 상한
- "문제→판단→해결→결과" 흐름이 있으면 "상(80~90)" 가능
- 학습/경험만 언급하면 "하(45~50)"
- 산출물 나열만 있으면 "상 불가"
- 같은 레벨 내에서도 근거의 강도에 따라 세부 점수 차등

---

## KPI별 상세 예시

## 1️⃣ UX 전략 (문제 재정의 & 해결 구조)

### 🔼 상
주어진 요구사항을 그대로 반영하지 않고, 사용자 행동과 맥락을 분석해 핵심 문제를 재정의했습니다. 디자인이 해결해야 할 경험 과제를 명확히 설정하고, 이를 중심으로 전체 설계 방향을 정리했습니다.

### 🔽 중
사용자 불편 사항을 정리해 디자인 개선 방향을 도출했습니다.

### 🔻 하
요청된 화면을 그대로 디자인했습니다.

---

## 2️⃣ 정보 구조 & 사용자 플로우 최적화

### 🔼 상
정보와 기능을 재구성해 사용자가 목표에 도달하는 흐름을 단순화했습니다. 플로우 개선을 통해 사용자가 막히는 구간을 제거했습니다.

### 🔽 중
기존 정보 구조를 기반으로 화면 흐름을 정리했습니다.

### 🔻 하
화면 목록을 나열해 디자인했습니다.

---

## 3️⃣ UI 시각 디자인·비주얼 완성도

### 🔼 상
타이포, 컬러, 레이아웃을 통해 시각적 우선순위를 명확히 설계하고, 한눈에 이해되는 화면을 구현했습니다.

### 🔽 중
디자인 가이드를 참고해 화면을 완성했습니다.

### 🔻 하
기본 컴포넌트 위주로 화면을 구성했습니다.

---

## 4️⃣ 프로토타이핑 & 인터랙션 구현

### 🔼 상
실제 사용 맥락을 반영한 인터랙션을 설계하고, 프로토타입을 통해 디자인 의도를 검증했습니다.

### 🔽 중
기본적인 인터랙션을 프로토타입으로 구현했습니다.

### 🔻 하
정적인 화면만 디자인했습니다.

---

## 5️⃣ 디자인 시스템 구축·운영

### 🔼 상
컴포넌트와 가이드라인을 체계화해 디자인 시스템을 구축하고, 확장과 일관성을 동시에 관리했습니다.

### 🔽 중
기존 디자인 시스템을 활용해 작업했습니다.

### 🔻 하
화면 단위로 디자인했습니다.

---

## 6️⃣ 데이터 기반 UX 개선

### 🔼 상
사용자 지표와 테스트 결과를 분석해 UX 문제를 정의하고, 디자인 개선으로 연결했습니다.

### 🔽 중
사용자 피드백을 참고해 디자인을 수정했습니다.

### 🔻 하
개인 판단이나 감으로 디자인했습니다.

---

## 7️⃣ AI 디자인 활용 능력

### 🔼 상
AI 도구를 활용해 디자인 탐색과 제작 과정을 효율화하고, 결과를 비판적으로 선별·보완했습니다.

### 🔽 중
AI 도구를 참고해 디자인 아이디어를 얻었습니다.

### 🔻 하
AI 디자인 도구를 사용해본 적이 없습니다.

---

## 8️⃣ 멀티 플랫폼(OS·Web·App) 이해

### 🔼 상
플랫폼별 패턴과 제약을 고려해 각각에 맞는 사용자 경험을 설계했습니다.

### 🔽 중
플랫폼 가이드를 참고해 디자인했습니다.

### 🔻 하
단일 환경 기준으로만 디자인했습니다.

---

## 9️⃣ 협업·커뮤니케이션 능력

### 🔼 상
디자인 의도와 결정을 명확한 언어로 정리해 PM·개발과 공유하고, 구현 과정에서 발생한 이슈를 조율했습니다.

### 🔽 중
디자인 결과물을 전달하고 피드백을 반영했습니다.

### 🔻 하
결과물만 전달했습니다.

---

## 🔟 BX/BI 브랜드 경험 설계

### 🔼 상
브랜드 톤과 메시지를 UX 전반에 녹여 일관된 경험을 설계했습니다.

### 🔽 중
브랜드 가이드를 화면에 적용했습니다.

### 🔻 하
개별 화면 중심으로 디자인했습니다.
"""


# Few-shot 예시
FEW_SHOT_EXAMPLES = """
## 평가 예시

### 예시 A (UX 전략·데이터 기반 디자이너)
입력:
"모바일 기반 서비스의 이용률이 낮고 특정 단계에서 사용자가 이탈하는 문제가 반복되어, UX 관점에서 경험 구조를 재설계하는 역할을 맡았습니다. 단순히 화면을 개선하는 것이 아니라, 사용자가 어떤 흐름에서 망설이고 포기하는지를 중심으로 문제를 재정의했습니다. 초기 유입부터 주요 행동까지의 여정을 정리하고, 이탈이 집중되는 지점을 UX 이슈로 구조화해 우선순위를 설정했습니다. 이를 바탕으로 정보 구조와 플로우를 재구성했습니다. 기능을 나열하던 기존 구조를 사용자 목적 중심으로 재배치하고, 핵심 행동까지 도달하는 단계를 줄이도록 화면 흐름을 단순화했습니다. 이 구조를 기준으로 와이어프레임과 인터랙션 프로토타입을 제작해, 실제 사용 시 어떤 경로로 이동하는지가 명확히 보이도록 설계했습니다. 디자인 시각 요소 또한 흐름에 맞게 조정했습니다. 시선 이동과 정보 위계를 고려해 레이아웃과 타이포, 색상 대비를 조정했고, 중요한 행동 요소가 자연스럽게 강조되도록 컴포넌트를 정리했습니다. 이후 사용 로그와 간단한 사용성 테스트 결과를 참고해 특정 화면에서의 체류 시간과 이탈률 변화를 확인하며 디자인을 반복적으로 수정했습니다. 이 과정에서 단순히 보기 좋은 화면이 아니라, 사용자의 행동과 데이터로 검증되는 경험을 설계하는 것이 디자이너의 역할임을 체감했습니다. UX 전략, 구조 설계, 시각 디자인, 검증을 하나의 흐름으로 연결해 서비스의 실제 사용성을 개선하는 디자인을 추구하고 있습니다."

출력:
{"1": 85, "2": 85, "3": 85, "4": 85, "5": 45, "6": 85, "7": 45, "8": 45, "9": 65, "10": 45}

근거:
- KPI 1(85): "단순히 화면을 개선하는 것이 아니라, 사용자가 어떤 흐름에서 망설이고 포기하는지를 중심으로 문제를 재정의", 이탈 구간을 UX 이슈로 구조화하고 우선순위 설정 → 요구를 재정의 + 경험 과제를 명확히 설정 → 교과서적인 상
- KPI 2(85): "기능을 나열하던 기존 구조를 사용자 목적 중심으로 재배치", "핵심 행동까지 도달하는 단계를 줄이도록 화면 흐름을 단순화" → 플로우 재설계 + 병목 제거 → 강한 상
- KPI 3(85): "시선 이동과 정보 위계를 고려해 레이아웃과 타이포, 색상 대비 조정", "중요한 행동 요소가 자연스럽게 강조되도록 컴포넌트 정리" → 단순 적용이 아니라 우선순위·인지 설계 → 강한 상
- KPI 4(85): "와이어프레임과 인터랙션 프로토타입을 제작", "실제 사용 시 어떤 경로로 이동하는지가 명확히 보이도록 설계" → 검증 목적의 프로토타입 → 강한 상
- KPI 5(45): 컴포넌트, 가이드라인, 시스템 운영 언급 없음, 구조 설계는 있지만 시스템화는 없음 → 하
- KPI 6(85): "사용 로그와 사용성 테스트 결과를 참고", "체류 시간과 이탈률 변화를 확인하며 반복 수정" → 지표 → 디자인 → 재검증 루프 존재 → 강한 상
- KPI 7(45): AI 도구, 프롬프트, 생성 활용 전혀 없음 → 하
- KPI 8(45): 모바일 언급은 있으나 OS 패턴·플랫폼 제약 고려 없음 → 하
- KPI 9(65): 팀 협업·조율 명시적 언급은 없음, 그러나 UX 이슈 구조화·우선순위 설정 → 간접적 협업 신호 → 보통 중
- KPI 10(45): 브랜드, 톤, 메시지, 무드 언급 없음 → 하

### 예시 B (실무형·UI 시스템 중심 디자이너)
입력:
"웹 기반 서비스 리뉴얼 프로젝트에서 화면 설계와 UI 디자인을 담당했습니다. 기존 화면은 기능이 계속 추가되며 레이아웃과 컴포넌트가 제각각이었고, 같은 역할의 버튼이나 입력 요소도 화면마다 형태와 동작이 달라 사용성이 떨어지는 문제가 있었습니다. 이를 해결하기 위해 먼저 전체 화면을 기준으로 공통 요소를 정리하고, 버튼, 입력창, 카드, 모달 등의 UI 패턴을 하나의 규칙으로 통합했습니다. 각 화면의 정보 구조를 다시 정리해 불필요하게 중복되는 요소를 제거하고, 사용자가 한 화면에서 무엇을 해야 하는지 명확히 보이도록 레이아웃을 재구성했습니다. 이 과정에서 개발팀과 함께 컴포넌트 단위로 디자인을 정리해 전달했고, 이후 화면 추가나 수정 시에도 동일한 규칙을 적용할 수 있도록 디자인 시스템 형태로 관리했습니다. Figma를 활용해 주요 화면과 상태별 UI를 구성하고, 인터랙션 프로토타입을 제작해 화면 전환과 동작 흐름을 미리 확인할 수 있도록 했습니다. 이를 통해 개발 전에 UI와 인터랙션에 대한 합의를 맞추고, 구현 과정에서 발생할 수 있는 해석 차이를 줄일 수 있었습니다. 사용자 행동 데이터나 실험을 직접 설계하지는 않았지만, 서비스 운영 중 수집된 피드백을 바탕으로 시각적 위계와 인터랙션을 조정하며 사용성을 개선했습니다. 이 경험을 통해 저는 디자인을 일회성 산출물이 아니라, 일관된 규칙과 시스템으로 운영하는 것이 서비스 확장성과 협업에 중요하다는 것을 배우게 되었습니다."

출력:
{"1": 65, "2": 65, "3": 85, "4": 65, "5": 85, "6": 65, "7": 45, "8": 45, "9": 85, "10": 45}

근거:
- KPI 1(65): "사용성이 떨어지는 문제", "공통 요소를 정리하고 규칙 통합" → 문제는 인식했지만, 사용자 행동·맥락 기반 재정의는 없음 → 보통 중
- KPI 2(65): "정보 구조를 다시 정리", "중복 요소 제거" → 기존 구조 개선은 있으나, 목표 흐름 최적화·이탈 제거는 없음 → 보통 중
- KPI 3(85): 버튼·입력·카드·모달을 하나의 규칙으로 통합, 시각적 위계·일관성·컴포넌트화 → 전형적인 상위 UI 디자이너 시그널 → 강한 상
- KPI 4(65): 인터랙션 프로토타입 제작, 흐름 확인 목적 → 검증 실험까지는 아니므로 → 보통 중
- KPI 5(85): "디자인 시스템 형태로 관리", 컴포넌트 규칙화, 재사용, 확장 고려 → 시스템형 디자이너의 교과서적 상 → 강한 상
- KPI 6(65): 사용자 피드백 반영, 지표·로그·테스트는 없음 → 정성 기반 개선 → 보통 중
- KPI 7(45): AI 도구, 자동화, 프롬프트 언급 없음 → 하
- KPI 8(45): 반응형, OS 패턴, 멀티 디바이스 고려 없음 → 하
- KPI 9(85): 개발팀과 컴포넌트 단위 협업, 해석 차이 제거 목적, 디자인 전달 구조화 → 디자이너 협업 KPI에서 상 → 강한 상
- KPI 10(45): 브랜드, 톤, 무드, 정체성 언급 없음 → 하

### 예시 C (인터랙션·프로토타이핑 중심 디자이너)
입력:
"신규 기능 도입 프로젝트에서 사용자 흐름과 인터랙션 설계를 중심으로 디자인을 담당했습니다. 기존 서비스는 기능 자체는 충분했지만, 화면 전환과 입력 과정이 복잡해 사용자가 어디에서 무엇을 해야 하는지 혼란스러워하는 문제가 있었습니다. 이를 해결하기 위해 단순히 화면을 나열하는 방식이 아니라, 사용자가 실제로 어떤 순서로 행동하는지를 기준으로 플로우를 다시 구성했습니다. 주요 기능에 대해 시나리오를 작성하고, 각 단계에서 사용자가 보게 되는 화면과 선택지를 연결해 전체 흐름을 정리했습니다. 이 플로우를 기반으로 Figma에서 인터랙션이 포함된 프로토타입을 제작해, 클릭·전환·오류 상황까지 실제 사용과 유사하게 구현했습니다. 이를 통해 팀이 기능 동작을 코드 없이도 직접 체험할 수 있게 했고, 개발 착수 전에 불필요한 단계와 혼란을 줄일 수 있었습니다. 프로토타입 테스트 과정에서 사용자가 특정 단계에서 머뭇거리거나 잘못된 선택을 하는 모습을 관찰했고, 이를 바탕으로 버튼 위치와 안내 문구, 화면 전환 방식을 수정했습니다. 이렇게 수정된 흐름을 다시 프로토타입에 반영해 반복적으로 검증하며 인터랙션을 다듬었습니다. UI 스타일과 비주얼은 기존 가이드를 따랐지만, 사용자가 느끼는 흐름과 조작 감각을 중심으로 디자인을 개선한 경험을 통해, 화면의 모양보다 인터랙션과 전환이 사용자 경험에 더 큰 영향을 준다는 점을 체감했습니다."

출력:
{"1": 65, "2": 85, "3": 65, "4": 85, "5": 45, "6": 65, "7": 45, "8": 45, "9": 65, "10": 45}

근거:
- KPI 1(65): "화면 전환과 입력 과정이 복잡해 사용자가 혼란", 사용자 행동 순서를 기준으로 플로우를 재구성 → 문제를 "요청 반영"이 아니라 사용자 혼란(경험 문제)로 정의했지만, 사용자 행동/맥락 분석을 통한 핵심 문제 재정의(전략 레벨)까지는 명시가 약함 → 보통 중
- KPI 2(85): "사용자가 실제로 어떤 순서로 행동하는지를 기준으로 플로우를 다시 구성", "불필요한 단계와 혼란을 줄임" → 목표 도달 흐름을 단순화하고 막히는 구간을 제거 → 강한 상
- KPI 3(65): "UI 스타일과 비주얼은 기존 가이드를 따름" → 직접 우선순위/타이포/컬러 설계로 '한눈에 이해'까지 끌고 간 서술은 없음, 하지만 화면 완성은 했으므로 → 보통 중
- KPI 4(85): "인터랙션 포함 프로토타입", "클릭·전환·오류 상황까지 실제 사용과 유사하게 구현", "프로토타입 테스트 → 관찰 → 수정 → 반복 검증" → 의도 검증까지 포함된 교과서적인 상 → 강한 상
- KPI 5(45): 컴포넌트/가이드라인 체계화, 시스템 운영 언급 없음 → 하
- KPI 6(65): "프로토타입 테스트 과정에서 관찰", 개선 반복은 있으나 지표/테스트 결과 분석(정량·A/B)은 없음 → 테스트/관찰 기반 개선 → 보통 중
- KPI 7(45): AI 도구 활용 언급 없음 → 하
- KPI 8(45): 플랫폼별 패턴/제약 고려 언급 없음 → 하
- KPI 9(65): "팀이 기능 동작을 코드 없이 체험", 개발 착수 전 혼란 제거 목적 → 협업 임팩트는 있으나, 의사결정 언어로 정리/이슈 조율까지 명시되지 않아 → 보통 중
- KPI 10(45): 브랜드 톤/메시지/경험 설계 언급 없음 → 하

### 예시 D (실무 UI 디자이너·협업·적용 중심)
입력:
"웹 서비스 운영 프로젝트에서 디자인 시안 제작과 개발 전달을 담당했습니다. 기획서와 와이어프레임을 기반으로 주요 화면과 UI 요소를 디자인했으며, 개발팀이 바로 구현할 수 있도록 컴포넌트 단위로 정리해 전달했습니다. 버튼, 입력창, 리스트, 카드 등 반복적으로 사용되는 요소는 동일한 규칙과 스타일을 유지하도록 정리해 화면 간 일관성을 확보했습니다. 디자인 과정에서는 화면이 실제 개발 환경에서 어떻게 구현되는지를 고려해, 픽셀 단위 레이아웃보다는 반응형을 감안한 여백과 정렬 기준을 중심으로 설계했습니다. 개발 중에는 구현 결과를 확인하며 디자인과 다르게 표현되는 부분을 조정하고, 필요한 경우 UI를 현실적인 방향으로 수정해 적용했습니다. 또한 기능 변경이나 추가 요청이 발생할 때마다 해당 화면과 연관된 디자인 요소를 빠르게 업데이트해, 개발 일정에 맞춰 필요한 산출물이 제공되도록 관리했습니다. 이를 통해 디자인이 뒤처져 개발이 멈추는 상황을 최소화할 수 있었습니다. 사용자 리서치나 실험을 직접 주도하지는 않았지만, 운영 중 접수되는 사용자 피드백과 기획 변경 사항을 반영해 화면 구성과 표현 방식을 조정하며 서비스 완성도를 높였습니다. 이 경험을 통해 저는 디자인이 기획과 개발 사이를 연결하는 실무적 역할임을 이해하게 되었습니다."

출력:
{"1": 45, "2": 45, "3": 65, "4": 45, "5": 65, "6": 65, "7": 45, "8": 65, "9": 85, "10": 45}

근거:
- KPI 1(45): 기획서·와이어프레임 기반 작업, UX 문제 재정의, 사용자 맥락 분석 없음 → 요청된 구조를 구현한 디자이너 → 하
- KPI 2(45): 플로우 설계·구조 재배치 언급 없음, 화면 단위 적용 → 하
- KPI 3(65): 버튼, 입력, 리스트, 카드 스타일 통합, 화면 일관성 유지 → 실무 UI 완성도는 있음 → 보통 중
- KPI 4(45): 프로토타입·인터랙션 설계 없음 → 하
- KPI 5(65): 반복 요소를 동일 규칙으로 정리, 다만 시스템화·문서화 언급 없음 → 부분적 시스템화 → 보통 중
- KPI 6(65): "운영 중 접수되는 사용자 피드백 반영", 지표·테스트는 없지만 개선 루프 존재 → 보통 중
- KPI 7(45): AI 도구 활용 없음 → 하
- KPI 8(65): "반응형을 감안한 여백과 정렬 기준", 디바이스 대응 고려 → 보통 중
- KPI 9(85): 컴포넌트 단위 전달, 개발 결과 확인 → 조정 → 재전달, 일정 맞춰 산출물 관리 → 실무 협업형 디자이너의 교과서적 상 → 강한 상
- KPI 10(45): 브랜드, 톤, 무드 설계 없음 → 하

### 예시 E (비주얼·브랜드 감각형 디자이너)
입력:
"브랜드 아이덴티티를 강화하는 방향으로 서비스 UI 디자인을 담당했습니다. 기존 화면은 기능 위주로 구성되어 있어 브랜드의 성격과 톤이 잘 드러나지 않는다는 문제가 있었고, 이를 개선하기 위해 색상, 타이포그래피, 이미지 스타일을 중심으로 전체 화면의 인상을 정리했습니다. 서비스가 전달하고자 하는 분위기와 타깃 사용자 이미지를 기준으로 무드보드를 구성하고, 이를 토대로 UI의 비주얼 방향성을 설정했습니다. 메인 화면과 주요 진입 화면에서는 브랜드 컬러와 그래픽 요소를 적극적으로 활용해 첫 인상이 명확하게 남도록 디자인했고, 버튼과 아이콘, 카드 컴포넌트에도 동일한 톤을 적용해 시각적 일관성을 유지했습니다. 이 과정에서 디자인 토큰 형태로 컬러와 폰트, 간격 규칙을 정리해 다른 화면에서도 같은 브랜드 감각이 유지되도록 관리했습니다. 화면 전환과 인터랙션보다는 시각적 완성도와 분위기 전달에 초점을 두었으며, 사용자에게 주는 감정적 인상을 중요하게 고려해 레이아웃과 비주얼 요소를 배치했습니다. 사용성이나 데이터 기반 개선보다는 브랜드 이미지와 첫 인상을 강화하는 역할에 집중한 경험을 통해, 디자인이 제품의 정체성을 만드는 중요한 요소임을 체감했습니다."

출력:
{"1": 65, "2": 45, "3": 85, "4": 45, "5": 65, "6": 45, "7": 45, "8": 45, "9": 45, "10": 85}

근거:
- KPI 1(65): "브랜드 성격과 톤이 드러나지 않는 문제", 브랜드 관점의 문제 재정의 → UX가 아니라 브랜드 경험 관점의 문제 정의, 그래도 요구를 그대로 그린 게 아니라 재정의했으므로 → 보통 중
- KPI 2(45): 플로우, 단계, 목표 도달 구조 언급 없음, 화면 구성 중심 → 하
- KPI 3(85): 색상·타이포·이미지 스타일, 시각적 위계, 톤, 일관성 → 비주얼 디자이너의 교과서적 상 → 강한 상
- KPI 4(45): "화면 전환과 인터랙션보다는 시각적 완성도에 초점", 프로토타입·검증 없음 → 하
- KPI 5(65): "디자인 토큰 형태로 컬러·폰트·간격 규칙 정리" → 부분적 시스템화 → 보통 중
- KPI 6(45): "사용성이나 데이터 기반 개선보다는…", 지표·테스트·피드백 없음 → 하
- KPI 7(45): AI 도구 언급 없음 → 하
- KPI 8(45): 플랫폼 패턴·제약 고려 없음 → 하
- KPI 9(45): PM·개발 협업, 전달, 조율 언급 없음 → 하
- KPI 10(85): 무드보드, 브랜드 톤, 감정적 인상, 화면 전체에 일관 적용 → 브랜드 디자이너의 교과서적 상 → 강한 상
"""


def evaluate_resume_kpis(resume_text: str) -> Dict[int, int]:
    """
    이력서 텍스트를 LLM이 직접 평가하여 디자이너 KPI별 점수 산출.
    
    Few-shot Learning 방식으로 예시를 제공하고,
    LLM이 동일한 기준으로 새 이력서를 평가.
    
    Args:
        resume_text: 이력서/경력 텍스트
    
    Returns:
        {kpi_id: 점수} (점수는 40~90 범위의 정수)
    """
    client = OpenAI(api_key=settings.OPENAI_API_KEY)
    
    system_prompt = f"""너는 디자이너(Designer) 역량 평가 전문가다.
주어진 이력서/경력 텍스트를 읽고, 10개 KPI에 대해 점수를 매긴다.

{KPI_DEFINITIONS}

{FEW_SHOT_EXAMPLES}

## 출력 형식
반드시 JSON 형식으로만 응답해. 설명 없이 점수만 출력.
{{"1": 점수, "2": 점수, ..., "10": 점수}}

## 점수 부여 규칙 (중요!)
- 상 수준: 75~90 범위에서 근거 강도에 따라 차등 (예: 강한 상=88, 보통 상=82, 약한 상=76)
- 중 수준: 55~70 범위에서 근거 강도에 따라 차등 (예: 강한 중=68, 보통 중=62, 약한 중=56)
- 하 수준: 40~50 범위에서 근거 강도에 따라 차등 (예: 약간 언급=48, 거의 없음=44, 전무=40)

⚠️ 절대 45, 65, 85로 딱 떨어지게 점수를 매기지 마라. 반드시 범위 내에서 세밀하게 차등을 두어라.
"""

    user_prompt = f"""다음 이력서를 평가해줘:

{resume_text}

JSON 형식으로 10개 KPI 점수를 출력해."""

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.3,  # 약간의 변동성 허용
            response_format={"type": "json_object"}
        )
        
        result = response.choices[0].message.content
        scores = json.loads(result)
        
        # KPI ID를 int로 변환하고 범위 제한
        return {
            int(kpi_id): max(40, min(90, int(score))) 
            for kpi_id, score in scores.items()
        }
    
    except Exception as e:
        print(f"LLM 평가 오류: {e}")
        # 오류 시 기본값 반환
        return {i: 45 for i in range(1, 11)}
