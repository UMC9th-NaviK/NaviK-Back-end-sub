#!/usr/bin/env python3
"""백엔드 Few-shot 예시 A~E 정확도 테스트"""
import json
import urllib.request

API_URL = "http://127.0.0.1:8000/api/kpi/analyze/backend"

EXAMPLES = {
    "A (운영형·성능형)": {
        "text": """SW 마에스트로 과정에서 '절약 챌린지 서비스'를 주제로 팀에서 백엔드 및 인프라 개발을 맡았습니다. 방학 중 스터디로 JAVA, Spring, AWS의 핵심 이론을 익혔고, 이를 토대로 절약 챌린지 서비스에서 Spring Boot, AWS EC2/RDS, PostgreSQL 등을 활용해 주요 API 개발, 인프라, DB를 설계했습니다. 서비스 배포 후 운영하는 과정에서 다양한 문제를 마주하고, 이를 다양한 기술을 활용해 해결하는 과정에서 문제해결역량을 길렀습니다. 여기서 저는 에러율을 줄여 사용성을 높이기 위해 JAVA에서 제공하는 Sentry 라이브러리를 활용해 서버 내 API의 응답 시간이 0.8초가 초과되면 에러 메시지를 실시간으로 모니터링할 수 있도록 했습니다. 실제 에러 메시지를 통해 DB 인덱스 최적화로 응답 속도를 0.3초로 개선해 사용성을 증진시켰으며, 서비스 개선으로부터 유저가 긍정적인 리뷰를 남기기도 했습니다. 또, 이미지 로딩이 오래 걸리는 문제를 JAVA 내 이미지 라이브러리를 통해 해결했습니다. 유저가 인증한 챌린지 사진을 비동기 처리를 통해 이미지 해상도를 낮춰 DB에 저장하고 이를 제공함으로써 이미지 로딩 시간을 줄였고, 이로부터 유저 이탈률을 10% 감소시키기도 했습니다. 절약 챌린지 서비스를 운영하면서 능동적으로 협업하는 자세로 팀의 효율성을 증진시켰습니다. 앱 서비스 개발을 처음 접하는 팀원을 위해 매번 팀원의 업무에 관련된 기술 레퍼런스를 찾아 공유하여 팀원의 업무를 도왔습니다. 그뿐만 아니라 재택근무로 인해 진행 상황 및 문제 공유가 비효율적으로 이루어지는 문제를 해결하기 위해 팀 내 소통 채널 Slack을 활용해 문제 공유 게시판을 추가 개설하여, 매일 진행하는 데일리 스크럼 시간을 1시간에서 30분으로 줄였습니다.""",
        "expected": {1: 85, 2: 62, 3: 88, 4: 65, 5: 83, 6: 90, 7: 42, 8: 42, 9: 86, 10: 87}
    },
    "B (아키텍처·인프라형)": {
        "text": """대규모 트래픽 환경에서 안정적인 서비스를 운영하기 위해서는 애플리케이션 구현 역량뿐만 아니라, 성능·비용·안정성을 함께 고려한 인프라 수준의 판단이 중요하다고 생각합니다. 저는 서비스의 배포와 운영 과정에서 발생한 문제를 분석하고, 구조적인 해결책을 설계·적용한 경험을 보유하고 있습니다. 팀 프로젝트로 개발한 서비스를 클라우드 환경에 배포해 운영하던 중, 트래픽 증가로 인해 성능 저하와 운영 비용 증가 문제가 발생했습니다. 데이터베이스 쿼리 최적화와 캐시 전략 등 애플리케이션 레벨 개선을 시도했으나, 근본적인 한계가 있음을 인식하고 문제의 원인을 인프라 구조 관점에서 재정의했습니다. 이에 클라우드와 물리 서버 환경을 병행하는 구조로 전환하는 방안을 제안하고 실행을 주도했습니다. 서버 하드웨어를 직접 구성해 네트워크를 설계하고, 방화벽 설정을 포함한 보안 체계를 구축했으며, Docker 기반 컨테이너 배포와 모니터링 환경을 구성해 운영 안정성을 확보했습니다. 그 결과 기존 클라우드 환경 대비 운영 비용을 약 94% 절감하고, 컴퓨팅 자원을 8배 이상 확장해 트래픽 증가 상황에서도 안정적인 서비스 제공이 가능해졌습니다. 이 경험을 통해 저는 퍼블릭 클라우드의 유연성과 물리 인프라의 안정성이라는 각 환경의 특성을 이해하고, 서비스 요구사항에 맞는 아키텍처를 설계·운영할 수 있는 역량을 갖추게 되었습니다. 단순한 기능 구현을 넘어, 운영 환경과 장기적인 확장성을 고려한 기술적 의사결정을 수행하는 백엔드 엔지니어로서 기여하고자 합니다.""",
        "expected": {1: 85, 2: 70, 3: 78, 4: 88, 5: 90, 6: 85, 7: 70, 8: 60, 9: 75, 10: 90}
    },
    "C (순수 인프라형)": {
        "text": """서비스 운영 과정에서 트래픽 증가로 인해 응답 지연과 운영 비용 상승 문제가 발생했습니다. 초기에는 데이터베이스 쿼리 최적화와 캐시 적용 등 애플리케이션 레벨에서 해결을 시도했으나, 서비스 사용 패턴과 트래픽 특성을 고려했을 때 구조적인 한계가 있다고 판단했습니다. 이에 문제를 인프라 아키텍처 관점에서 재정의하고, 클라우드 환경과 물리 서버 환경을 병행하는 하이브리드 구조로 전환하는 방안을 제안하고 실행을 주도했습니다. 서버 하드웨어 구성부터 네트워크 설계, 방화벽 설정을 포함한 기본 보안 정책 수립까지 전반적인 인프라 구성을 담당했으며, Docker 기반 컨테이너 배포 환경을 구축해 배포 일관성을 확보했습니다. 또한 모니터링 도구를 연동해 자원 사용량과 장애 징후를 실시간으로 확인할 수 있도록 운영 환경을 개선했습니다. 그 결과 기존 대비 운영 비용을 크게 절감하면서도 트래픽 증가 상황에서도 안정적인 서비스 제공이 가능해졌습니다. 이 경험을 통해 단순 기능 구현을 넘어, 서비스 특성과 운영 환경에 맞는 구조를 설계하고 장기적인 안정성을 확보하는 백엔드 엔지니어로서의 역량을 강화할 수 있었습니다.""",
        "expected": {1: 80, 2: 65, 3: 70, 4: 85, 5: 88, 6: 90, 7: 42, 8: 48, 9: 70, 10: 85}
    },
    "D (실무형 주니어)": {
        "text": """팀 프로젝트에서 백엔드 개발을 담당하며 서비스 기능 구현과 운영을 경험했습니다. 요구사항에 맞춰 REST API를 구현하고 ORM을 사용해 데이터베이스 테이블 구조를 설계했으며, 클라우드 환경에 서비스를 배포해 운영했습니다. 서비스 사용량이 증가하면서 특정 API의 응답 속도가 느려지는 문제가 발생했고, 팀 내 논의를 통해 조회 빈도가 높은 컬럼을 기준으로 인덱스를 추가하는 방식으로 성능을 개선했습니다. 또한 운영 중 장애가 발생했을 때 로그를 확인해 원인을 파악하고, 코드 수정이나 설정 변경을 통해 문제를 해결하는 경험을 했습니다. 클라우드 환경에서의 배포와 기본적인 인프라 설정을 경험하며 서비스 운영 흐름을 이해할 수 있었지만, 아키텍처 구조나 인프라 구성에 대한 의사결정은 주로 팀에서 정한 방향에 따라 수행했습니다. 이 경험을 통해 백엔드 개발 전반의 흐름과 실무 환경에서의 역할 수행 능력을 기를 수 있었으며, 이후 보다 주도적인 기술적 판단 역량의 필요성을 인식하게 되었습니다.""",
        "expected": {1: 68, 2: 65, 3: 70, 4: 58, 5: 65, 6: 75, 7: 42, 8: 42, 9: 60, 10: 70}
    },
    "E (학습형 주니어)": {
        "text": """백엔드 개발을 처음 접하며 Spring Boot를 사용해 간단한 CRUD 기능을 구현한 경험이 있습니다. 강의 자료와 예제 코드를 참고해 컨트롤러와 서비스 로직을 작성하고, 데이터베이스와 연동해 기본적인 데이터 저장과 조회 기능을 구현했습니다. 로컬 환경에서 애플리케이션을 실행해 기능이 정상적으로 동작하는 것을 확인하며 백엔드 개발의 기본 흐름을 익혔습니다. 프로젝트를 진행하며 API 요청과 응답 구조, 데이터베이스 연동 방식에 대한 이해를 높일 수 있었지만, 성능 최적화나 아키텍처 설계, 운영 환경을 고려한 개선 작업까지는 경험하지 못했습니다. 또한 테스트 코드 작성이나 배포, 모니터링과 같은 운영 관련 작업에는 참여하지 않았습니다. 이 경험을 통해 백엔드 개발의 기초적인 개념과 구조를 학습할 수 있었으며, 이후 더 복잡한 서비스 환경에서의 개발과 운영 경험을 쌓기 위해 추가적인 학습과 프로젝트 참여가 필요하다고 느꼈습니다.""",
        "expected": {1: 45, 2: 45, 3: 45, 4: 45, 5: 45, 6: 45, 7: 45, 8: 45, 9: 45, 10: 45}
    }
}


def test_example(name, text, expected):
    req = urllib.request.Request(
        API_URL,
        data=json.dumps({"resume_text": text}).encode("utf-8"),
        headers={"Content-Type": "application/json"},
        method="POST",
    )
    try:
        with urllib.request.urlopen(req, timeout=120) as res:
            data = json.loads(res.read().decode("utf-8"))
    except Exception as e:
        print(f"  API 호출 실패: {e}")
        return 0
    
    scores_list = data.get("scores", [])
    actual = {item["kpi_id"]: item["score"] for item in scores_list}
    
    print(f"\n예시 {name}")
    print("-" * 50)
    diffs = []
    for kpi_id in range(1, 11):
        exp = expected.get(kpi_id, 0)
        act = actual.get(kpi_id, 0)
        diff = abs(exp - act)
        diffs.append(diff)
        status = "OK" if diff <= 5 else "X"
        print(f"  KPI {kpi_id:2d}: 예상={exp:2d}, 실제={act:2d}, 차이={diff:2d} [{status}]")
    
    accuracy = sum(1 for d in diffs if d <= 5) / len(diffs) * 100
    print(f"  정확도: {accuracy:.0f}%")
    return accuracy


def main():
    print("=" * 50)
    print("백엔드 Few-shot 예시 A~E 정확도 테스트")
    print("=" * 50)
    
    results = {}
    for name, data in EXAMPLES.items():
        accuracy = test_example(name, data["text"], data["expected"])
        results[name] = accuracy
    
    print("\n" + "=" * 50)
    print("종합 결과")
    print("=" * 50)
    for name, acc in results.items():
        status = "✓" if acc >= 80 else "✗"
        print(f"  {name}: {acc:.0f}% {status}")
    
    avg = sum(results.values()) / len(results)
    print(f"\n  평균 정확도: {avg:.0f}%")


if __name__ == "__main__":
    main()
